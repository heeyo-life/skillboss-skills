name: Release Skills

on:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    environment: prod
    permissions:
      contents: write
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10 # For changelog generation

      - name: Get version from config
        id: version
        run: |
          VERSION=$(jq -r .version skillboss/config.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Version: $VERSION"

      - name: Check if version already exists in R2
        id: check_exists
        continue-on-error: true
        run: |
          npx wrangler r2 object get "skillboss/versions/${{ steps.version.outputs.version }}.zip" --file=/tmp/r2_check && rm -f /tmp/r2_check

      - name: Fail if version exists
        if: steps.check_exists.outcome == 'success'
        run: |
          echo "‚ùå Version ${{ steps.version.outputs.version }} already exists in R2!"
          echo "   Please bump the version in skillboss/config.json before pushing."
          exit 1

      - name: Generate changelog from commits
        id: changelog
        run: |
          CHANGELOG=$(git log --oneline -10 --pretty=format:"- %s" | head -10)
          # Use delimiter for multiline output
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "üìù Changelog:"
          echo "$CHANGELOG"

      - name: Create zip
        run: |
          zip -r skillboss.zip skillboss/
          echo "üìÅ Zip size: $(du -h skillboss.zip | cut -f1)"

      - name: Calculate file hash
        id: hash
        run: |
          HASH=$(sha256sum skillboss.zip | cut -d' ' -f1)
          SIZE=$(stat -c%s skillboss.zip)
          echo "hash=$HASH" >> $GITHUB_OUTPUT
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "üîí SHA256: $HASH"
          echo "üìè Size: $SIZE bytes"

      - name: Upload to R2
        run: |
          npx wrangler r2 object put skillboss/versions/${{ steps.version.outputs.version }}.zip --file=skillboss.zip

      - name: Notify skillboss webhook
        env:
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
        run: |
          jq -n \
            --arg version "${{ steps.version.outputs.version }}" \
            --arg r2_key "versions/${{ steps.version.outputs.version }}.zip" \
            --argjson file_size ${{ steps.hash.outputs.size }} \
            --arg file_hash "${{ steps.hash.outputs.hash }}" \
            --arg changelog "$CHANGELOG" \
            --arg commit_sha "${{ github.sha }}" \
            '{version: $version, r2_key: $r2_key, file_size: $file_size, file_hash: $file_hash, changelog: $changelog, commit_sha: $commit_sha}' \
            > payload.json
          curl -f -X POST "${{ secrets.SKILLBOSS_WEBHOOK_URL }}/api/skills/webhook/release" \
            -H "Authorization: Bearer ${{ secrets.SKILLBOSS_WEBHOOK_SECRET }}" \
            -H "Content-Type: application/json" \
            -d @payload.json

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        continue-on-error: true # Don't fail if tag exists
        with:
          tag_name: v${{ steps.version.outputs.version }}
          name: v${{ steps.version.outputs.version }}
          body: |
            ## Changes
            ${{ steps.changelog.outputs.changelog }}

            ---
            üì¶ Also available via [skillboss.co](https://skillboss.co)
          files: skillboss.zip
          generate_release_notes: false
